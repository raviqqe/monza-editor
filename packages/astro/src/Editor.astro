---
import "monza-editor/style.css";
import { styles } from "monza-editor";
import type { Language, Theme } from "picolight";

interface Props {
  class?: string;
  id?: string;
  language: Language;
  theme: Theme;
  darkTheme?: Theme;
  value?: string;
}

const marshal = (_: string, value: unknown): unknown =>
  value instanceof RegExp ? { _r: value.source } : value;

const { id, language, theme, darkTheme, value, ...props } = Astro.props;
---

<monza-editor
  data-language={JSON.stringify(language, marshal)}
  data-theme={JSON.stringify(theme)}
  data-dark-theme={JSON.stringify(darkTheme)}
>
  <div class={`${styles.main} ${props.class}`} id={id}>
    <textarea class={styles.textarea}>{value}</textarea>
    <pre class={styles.pre}><code class={styles.code} /></pre>
  </div>
</monza-editor>
<script>
  import { initialize } from "monza-editor";
  import { highlight } from "picolight";

  class Editor extends HTMLElement {
    async connectedCallback(): Promise<void> {
      const { language, theme, darkTheme } = this.dataset;

      if (!language || !theme) {
        throw new Error("Editor props missing");
      }

      const div = this.querySelector("div");
      const textarea = this.querySelector("textarea");
      const pre = this.querySelector("pre");
      const code = this.querySelector("code");

      if (!div || !textarea || !pre || !code) {
        throw new Error("Editor elements missing");
      }

      const mediaQuery = window.matchMedia("(prefers-color-scheme: dark)");
      let dark = mediaQuery.matches;
      mediaQuery.addEventListener("change", (event) => (dark = event.matches));

      const unmarshal = (_key: string, value: unknown): unknown =>
        value instanceof Object && "_r" in value && typeof value._r === 'string' ? new RegExp(value._r) : value;

      initialize({
        code,
        highlight: (text) =>
          highlight(text, JSON.parse(language, unmarshal), JSON.parse( dark &&  darkTheme || theme)).outerHTML,
        pre,
        textarea,
      });
    }
  }

  customElements.define("monza-editor", Editor);
</script>
